\setchapterimage[6cm]{seaside}
\setchapterpreamble[u]{\margintoc}
\chapter{Intensional Type Theory}
\labch{layout}

Dependent type theories and in particular \MLTT, as originally
developed by~\sidecitet{MARTINLOF197573}, provide an adequate framework
for developing constructive mathematics and certifying software.
%
A core aspect of \MLTT is the coexistence of two distinct notions of
equality: a \emph{definitional} equality that records the equations
automated by the system, and a \emph{propositional} equality that is
a type internal to the system and thus can be used to do equational
reasoning.
%
However, the propositional equality of \MLTT lacks some extensionality
principles that pervade mathematical reasoning, such as function
extensionality (funext). Since they are generally considered desirable, these
principles are sometimes added as axioms, but doing so results in a system
with weaker computational properties.

Throughout the years, several options
to obtain a more extensional version of propositional equality while preserving
computation have been explored. The most successful lines of work can be roughly divided into two
groups: the ones using an observational equality, and the ones using a
cubical equality.
%
Both notions build on the following fundamental idea: in order to obtain
sufficient extensionality principles, the behavior of equality in a given
type should be explicitly specified for every type instead of using a single
definition that is parametric over the types.

The work on observational equality originated from the study of
the setoid model of type theory \sidecite{hofmann95,altenkirch99}, and
a first attempt at a proper type theory that supports an observational
equality satisfying funext has been been proposed in~\sidecite{altenkirchAl:plpv2007}.
%
In these systems, observational equality equips every type with a setoid
structure. This setoidal equality satisfies the uniqueness of identity proofs (UIP),
which states that all proofs of an equality are equal; in other words,
equality is proof-irrelevant.

The other line of work is more recent and takes its roots in the
formulation of the univalence axiom~\sidecite{kapulkin2012simplicial,hottbook},
which gives a new meaning to the equality between types: two types are
equal when they equivalent. This can be understood as an extensionality
principle for the universe of types.
%
In their search for a computational interpretation of
univalence, \sidecitet{cubicaltt} developed a notion of cubical equality,
which satisfies funext and univalence, but is incompatible with UIP.

Thus, observational equality and cubical equality are two diverging
directions for providing propositional equality with more extensionality.
\sidecitet{hts-sota,Altenkirch2016ExtendingHT,Capriotti17} advocate that the
two solutions are actually complementary and can be integrated to
a single system with two universe hierarchies, one that satisfies
univalence and the other that satisfies UIP.
%
While cubical type theory has been thoroughly investigated and even
implemented in the \Agda proof assistant~\sidecitet{cubical-agda},
observational equality has not reached a comparable level of maturity.
%
Recent attempts to design a type theory based on observational equality
are either lacking an algorithm for type checking~\sidecitet{sterling_et_al:LIPIcs:2019:10538}, or restricted to a single
universe and having computational properties only up to a
conjecture~\sidecitet{Altenkirch2019}. Indeed, the latter relies on computation
in an enriched version of \MLTT that features a universe of definitionally
proof-irrelevant types (noted hereafter $\sProp$) as recently proposed
by~\sidecitet{gilbert:hal-01859964}, along with a proof-irrelevant identity type
that supports a strong eliminator. This theory has not been justified yet,
and it has even been shown not to be normalizing in presence of
impredicativity~\sidecitet{lmcs:6606}.

In this paper, we define \SetoidTT, the first extension of \MLTT +
$\sProp$ with an observational equality that satisfies UIP, funext
and propext, and supports quotient types and countably many universes
---with a proof of normalization and canonicity formalized in \Agda.\footnote{The formalization is available at
  \url{https://github.com/CoqHott/logrel-mltt/}, references to a
  particular file are done using \refAgda{}{myfile} which
  directly points to the corresponding file on github.}
%
Firstly, we remark that this theory can only be derived in a system with
some level of cumulativity, as it is required for certain
computation rules to be well-typed. This makes explicit some difficulties
that do not show up in previous works.
%
Second, we remark that our version of observational equality can be equipped
with two elimination principles: a notion of type cast (or coercion) for
proof-relevant types, and the standard eliminator of \MLTT for
proof-irrelevant types, thus making all the setoidal structure
derivable from the standard eliminator.
%
Funext and propext are obtained by specifying the right
computation rules for observational equality whereas UIP is obtained
for free by interpreting observational equality in $\sProp$.

The proof of normalization and canonicity is based on the use
of logical relations defined in \Agda using induction-recursion as
initially developed by \sidecitet{Abel:POPL2018} and later extended to
$\sProp$ by~\sidecitet{gilbert:hal-01859964}.
%
Compared to previous work on formalized normalization proofs, we have added the support
for a cumulative hierarchy with two universes, and we make a clear distinction
between inhabitants of proof-irrelevant types, which have no computational
behavior, and inhabitants of proof-relevant types, which do.
%
This key change allows us to add new principles in $\sProp$ without
having to supply them with a computational behavior, trivializing for
instance the management of higher coherences of the cubical interpretation.
%
In counterpart for this added flexibility, normalization does not directly
imply canonicity anymore, and a separate proof of consistency of the
theory is required to derive canonicity.
%
This proof is done by defining a model for \SetoidTT, but as
consistency is the only consequence that we need from the existence of
a model, the model can be defined in an extensional setting.

To illustrate the simplicity of extending \MLTT+$\sProp$ to \SetoidTT,
we have implemented a simple version in
\Agda using rewrite rules, as recently introduced
by~\sidecitet{taming_of_the_rew} (file \refAgdaRoot{setoid\_rr}).

\section{Related work}

Compared to~\sidecite{altenkirchAl:plpv2007}, the most important ingredient in \SetoidTT is the
use of definitional proof-irrelevance.
%
This added flexibility in computations allows our recursors to enjoy proper computational
behavior on open terms, and it also lets us seamlessly treat universe hierarchies.
%
Moreover, the normalization proof for OTT relies on a normalization conjecture for a different
theory, unlike the normalization proof for \SetoidTT.

In~\sidecite{Altenkirch2019}, the authors define a setoid model in \( \MLTT+\sProp \). Then, they
interpret a version of \MLTT with proof-irrelevant identity types that support propext and
funext in their model, thereby providing a computational interpretation of these principles.
%
However, handling universes in their model requires some additions to \( \MLTT+\sProp \), and
the resulting theory is only conjectured to be normalizing.
%
In contrast to this, \SetoidTT is a full-fledged type theory and does not require any external
model to compute.

Compared to XTT~\sidecite{sterling_et_al:LIPIcs:2019:10538}, the strengths of \SetoidTT are a
normalization strategy that exhibits canonicity, as well a full proof that conversion and typing
are decidable. These properties allow us to present a concrete implementation of our system
in a proof assistant.
%
In XTT however, Sterling\etal show that typing cannot be decidable, as there is no way to deduce
\( \Obseq{A}{A'} \) and \( \Obseq{B}{B'} \) from a proof of \( \Obseq{A \times B}{A' \times B'} \).
%
In order to fix this shortcoming, they suggest adding a ``typecase'' operator, but
argue against it since it forces the universe to be closed, thereby severely constraining the
possible semantics.
%
In \SetoidTT, we obtain the injectivity of type contructors from the behavior of observational
equality in the universe. These rules somewhat constrain the semantics---for instance, we cannot
interpret \SetoidTT in set theory using a Grothendieck universe as the interpretation of \( \Type \)---but our universe remains open to the addition of arbitrary types.

\section{Impred}



In dependent type theory, a sort \( \sProp \) is said to be
\emph{impredicative} if it is closed under dependent products over any index
type: for all types \( A \) and functions \( \tm{B}{A \to \sProp} \),
the dependent product \( \Depfun{A}{B\ x} \) is in \( \sProp \).
%
In particular, impredicativity allows the definition of self-referential propositions,
which quantify over the type \( \sProp \) of all propositions and may thus
be applied to themselves.
%
In addition to providing a tremendous amount of logical power, impredicativity is
a crucial ingredient in common mathematical constructions, such as
Tarski's fixed point theorem or lattice theory~\sidecite{paco}.
%
On the other side of the coin, a predicative hierarchy $(\varType_i)_{i \in \Nat}$
requires dependent products to inhabit a higher universe level
than their domain and codomain: for all types \( A : \varType_i \) and functions
\( \tm{B}{A \to \varType_j} \), the dependent product
\( \Depfun{A}{B\ x} \) is in \( \varType_{max(i,j)} \).
%
While the latter is easier to model, as the universes $\varType_i$ can be
constructed incrementally by induction on the level $i$, it results
in a theory that is less flexible in practice, whether the mention of
levels is explicit (as in \Agda) or implicit (as in \Coq).
%
Impredicative propositions make for an altogether
more comfortable framework, in which less universe levels have to
be dealt with.

While impredicativity is a prominent feature of the Calculus of
Constructions~\sidecite{Coquand-CC}, and by extension of \Coq, it is
absent from the standard presentation of Martin-Löf type theory
(\MLTT~\sidecite{MARTINLOF197573}), and not available in \Agda.
%
This reluctance may be explained by the sheer difficulty of designing models
to reason about impredicative theories, and by the numerous incompatibility
results, from \sidecitet{hurkens95} paradox to the more recent proof by
\sidecitet{lmcs:6606} that a naive implementation of uniqueness of identity
proofs (UIP) via definitionally proof-irrelevant equalities breaks \Coq's
normalization algorithm on impredicative propositions.

However, as noted by Abel and Coquand, it is not clear whether that last
result stems from a deep incompatibility between UIP and impredicativity,
or if it is an artifact of an inadequate type-checking algorithm.
%
Clarifying this issue seems especially important given the renewed
interest in definitional proof-irrelevance and UIP shown by the community
in recent years~\sidecite{sterling_et_al:LIPIcs:2019:10538,pujet:hal-03367052,Altenkirch2019}.
%
For instance, the recent presentation \SetoidTT of observational
equality of \sidecitet{pujet:hal-03367052} has an equality which can be
eliminated using a cast operator that computes differently from the
usual eliminator of Martin-Löf identity type, as used by \sidecitet{lmcs:6606}.


In this paper, we show that impredicativity is harmless when confined
to a sort of definitionally proof-irrelevant propositions, as it is never
necessary to compute with irrelevant proof terms.
%
As a result, we are able to extend \SetoidTT with impredicativity while
preserving definitional UIP and all extensionality principles that come
with an observational type theory (such as propositional or function
extensionality).
%
The resulting system, dubbed \SetoidCC, still enjoys
normalization via inductive-recursive logical relations---no
realizability model is needed---and decidability of type-checking.
%
This result has been formalized in \Agda using the framework of
\sidecitet{Abel:POPL2018}.\footnote{see anonymous supplementary
  materials.}
%
The fact that a proof scheme that has been designed with predicative
theories in mind carries through in an impredicative setting
may come as a surprise.
%
The crux of the proof is to realize that we can get away with
remarkably little structure in the interpretation of the impredicative
dependent products and sums, to the extent that we do not even mention the
interpretation of the domain and codomain.
%
We manage to prove the soundness of our normalization model
despite this weaker induction hypothesis by using a \emph{paranoid}
version of the type system, which can then be proven equivalent to the
\emph{economic} version (a terminology introduced by
\sidecitet{andrej17:paranoid}).

%
Furthermore, we prove that normalization for \SetoidCC can be
carried in plain Martin-Löf type theory with indexed inductive types,
thereby showing that this impredicative universe does not contribute
to the computational power of the proof-relevant fragment at all,
despite the increase in logical power.
%
We also investigate the possibility of recovering the lost computational power
from a proof-relevant impredicative universe, hoping that the different
computational behaviour of \SetoidCC would allow us to circumvent Abel and
Coquand's argument, but alas, it does not. In fact, a slightly modified
argument shows undecidability of type-checking in presence of a
proof-relevant impredicative universe.
%
Therefore, we exhibit a tradeoff between the additional comfort of
UIP and extensionality principles, or the possibility to compute with
impredicative functions.

Finally, because our normalization proof does not imply logical
consistency, we define a model of \SetoidCC in ZF Set
theory.
%
This shows that the computational content of \SetoidCC can be studied
without impredicativity in the metatheory, while the study of the
logical content of \SetoidCC fundamentally requires impredicativity in
the metatheory. 

\section{the two problems being solved}

Intensional computation with extensional principles

Normalization of proof-irrelevant impredicative universe with elimination of false and equality

\section{history of setoids}

Hofmann : Extensional concepts in intensional type theory (PhD thesis, 95)

First model of ETT in ITT. Does not support universes because no proof-relevant equality.

Altenkirch : Extensional Equality in Intensional Type Theory (LICS99)

Full model of ETT in ITT + sProp, using CwF of setoids.

Altenkirch, McBride : 

Altenkirch, McBride : Observational Equality, Now! (PLPV07)

Normalization ``proof'', canonicity from consistency, proof-irrelevant axioms 
are fine, heterogeneous equality.

McBride et al : Epigram 2

Altenkirch, Boulier, Kaposi, Tabareau :

Sterling :

\section{to put somewhere}

impossible to have canonicity for equality

explain the n+4

\sideremark{The \Coq proof assistant extends to the base calculus
of constructions
Predicative Calculus of Cumulative Inductive Constructions \cite{pcuic}}

Mixing type coercion operators and impredicative propositions is well known to 
be a minefield:
% % 
% in his seminal work on System F, Girard already shows that adding an operator 
% \( {J : \forall A\ B\ .\ A \to B} \) with the reduction rule
% \( {J\ A\ A\ t \Rightarrow t} \) breaks normalization \sidecite{girard72}.
in recent years, Coquand and Abel showed that the interaction of the two features 
breaks normalization in the type theory of \Lean \sidecite{lmcs:6606}.
% 
Still, they leave an open question: is there a way to decide conversion without

% And does the same argument applies to the observational equality of \SetoidCC, 
% which computes in a different way?
 
% As we will see, the answers to those questions are respectively ``no'' and 
% ``yes''.